<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Ciris v1.0.0 · Ciris</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="Ciris v1.0.0 was announced less than a week ago, on October 28th, 2019. The release features a complete rewrite of the library, now reimagined and based upon [Cats](https://typelevel.org/cats) and [Cats Effect](https://typelevel.org/cats-effect). In this post, we&#x27;ll highlight the most important changes in v1.0.0, and compare it with the v0.x versions."/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Ciris v1.0.0 · Ciris"/><meta property="og:type" content="website"/><meta property="og:url" content="https://cir.is/blog/2019/11/01/ciris-v1.0.0"/><meta property="og:description" content="Ciris v1.0.0 was announced less than a week ago, on October 28th, 2019. The release features a complete rewrite of the library, now reimagined and based upon [Cats](https://typelevel.org/cats) and [Cats Effect](https://typelevel.org/cats-effect). In this post, we&#x27;ll highlight the most important changes in v1.0.0, and compare it with the v0.x versions."/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css"/><link rel="alternate" type="application/atom+xml" href="https://cir.is/blog/atom.xml" title="Ciris Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://cir.is/blog/feed.xml" title="Ciris Blog RSS Feed"/><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/ciris.white.svg" alt="Ciris"/><h2 class="headerTitleWithLogo">Ciris</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/blog/" target="_self">Blog</a></li><li class=""><a href="/api/ciris/index.html" target="_self">API Docs</a></li><li class=""><a href="/docs/overview" target="_self">Documentation</a></li><li class=""><a href="https://github.com/vlovgr/ciris" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Blog Posts</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Blog Posts</h3><ul class=""><li class="navListItem navListItemActive"><a class="navItem" href="/blog/2019/11/01/ciris-v1.0.0">Ciris v1.0.0</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer postContainer blogContainer"><div class="wrapper"><div class="lonePost"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle"><a href="/blog/2019/11/01/ciris-v1.0.0">Ciris v1.0.0</a></h1><p class="post-meta">November 1, 2019</p><div class="authorBlock"><p class="post-authorName"><a href="https://vlovgr.se" target="_blank" rel="noreferrer noopener">Viktor Lövgren</a></p><div class="authorPhoto"><a href="https://vlovgr.se" target="_blank" rel="noreferrer noopener"><img src="https://avatars0.githubusercontent.com/u/1163201?s=460&amp;v=4" alt="Viktor Lövgren"/></a></div></div></header><div><span><p>Ciris v1.0.0 was announced less than a week ago, on October 28th, 2019. The release features a complete rewrite of the library, now reimagined and based upon <a href="https://typelevel.org/cats">Cats</a> and <a href="https://typelevel.org/cats-effect">Cats Effect</a>. In this post, we'll highlight the most important changes in v1.0.0, and compare it with the v0.x versions.</p>
<p>Refer to the <a href="https://cir.is/docs/overview">documentation</a> for more detailed information on v1.0.0.</p>
<!--truncate-->
<h2><a class="anchor" aria-hidden="true" id="why-cant-i-just-flatmap-parmapn-"></a><a href="#why-cant-i-just-flatmap-parmapn-" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Why can't I just <code>flatMap</code>, <code>parMapN</code>, ...?</h2>
<p>Ciris v0.x had custom functions <code>loadConfig</code> (roughly equivalent to <code>parMapN</code>) and <code>withValues</code> (roughly equivalent to <code>parTupled.flatMap</code>) for loading configurations. These were a consequence of having <a href="https://www.scala-native.org">Scala Native</a> support, a platform where Cats is <a href="https://github.com/typelevel/cats/issues/1549">still unavailable</a>. Ciris v1.0.0 is not available on Scala Native, and depends on Cats while providing relevant type class instances.</p>
<p>As a result, code which used to look something like this in v0.x:</p>
<pre><code class="hljs css language-scala">withValues(envF[<span class="hljs-type">IO</span>, <span class="hljs-type">AppEnvironment</span>](<span class="hljs-string">"APP_ENV"</span>)) { environment =&gt;
  loadConfig(
    apiConfig(environment),
    databaseConfig
  ) { (api, database) =&gt;
    <span class="hljs-type">Config</span>(
      appName = <span class="hljs-string">"my-api"</span>,
      environment = environment,
      api = api,
      database = database
    )
  }
}
</code></pre>
<p>can now instead be written as follows in v1.0.0.</p>
<pre><code class="hljs css language-scala">env(<span class="hljs-string">"APP_ENV"</span>).as[<span class="hljs-type">AppEnvironment</span>].flatMap {
  (
    apiConfig(environment),
    databaseConfig
  ).parMapN { (api, database) =&gt;
    <span class="hljs-type">Config</span>(
      appName = <span class="hljs-string">"my-api"</span>,
      environment = environment,
      api = api,
      database = database
    )
  }
}
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="why-envenvf-proppropf-"></a><a href="#why-envenvf-proppropf-" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Why <code>env</code>/<code>envF</code>, <code>prop</code>/<code>propF</code>, ...?</h2>
<p>Ciris v0.x distinguished between pure and effectful configuration values. In Ciris v1.0.0, we require an effect type compatible with Cats Effect to load configurations. Loading is described using Cats Effect type classes, meaning you don't have to keep repeating the effect type for every <code>envF</code>, <code>propF</code>, and so on.</p>
<p>Additionally, there is now only one version per source: <code>env</code>, <code>prop</code>, and <code>file</code>. These no longer accept type arguments, and decoding of configuration values is done through <code>as</code>. Code which used to look something along the following lines in Ciris v0.x:</p>
<pre><code class="hljs css language-scala">loadConfig(
  envF[<span class="hljs-type">IO</span>, <span class="hljs-type">AppEnvironment</span>](<span class="hljs-string">"APP_ENV"</span>),
  envF[<span class="hljs-type">IO</span>, <span class="hljs-type">Int</span>](<span class="hljs-string">"MAX_RETRIES"</span>)
)(<span class="hljs-type">Config</span>).orRaiseThrowable
</code></pre>
<p>can now instead be written as follows in v1.0.0.</p>
<pre><code class="hljs css language-scala">(
  env(<span class="hljs-string">"APP_ENV"</span>).as[<span class="hljs-type">AppEnvironment</span>],
  env(<span class="hljs-string">"MAX_RETRIES"</span>).as[<span class="hljs-type">Int</span>]
).parMapN(<span class="hljs-type">Config</span>).load[<span class="hljs-type">IO</span>]
</code></pre>
<p>This allows configuration sources to focus on loading values, and not how to decode to different types.</p>
<h2><a class="anchor" aria-hidden="true" id="unifying-and-simplifying-concepts"></a><a href="#unifying-and-simplifying-concepts" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Unifying and simplifying concepts</h2>
<p>In Ciris v0.x, there were three similar concepts: <code>ConfigEntry</code>, <code>ConfigValue</code>, and <code>ConfigResult</code>. In Ciris v1.0.0, there is now only a single concept, <code>ConfigValue</code>, for describing configurations. This concept can be used to describe both horizontal composition (fallback values) and vertical composition (sequentially or parallelly).</p>
<p>Similarly to <code>orElse</code>, <code>orNone</code>, and <code>orValue</code> in v0.x, <code>or</code> can be used in v1.0.0 to use fallback values. Default values are now a first-class construct, meaning they can be <a href="https://cir.is/docs/configurations#defaults">reasoned about</a>. In v0.x, we could not distinguish between default values and loaded values.</p>
<pre><code class="hljs css language-scala">env(<span class="hljs-string">"MAX_RETRIES"</span>).or(prop(<span class="hljs-string">"max.retries"</span>)).as[<span class="hljs-type">Int</span>].option
</code></pre>
<p>In the above example, <code>.option</code> is equivalent to <code>.map(_.some).default(None)</code>, and <code>.default(None)</code> can also be written as <code>.or(default(None))</code>. Later defaults override earlier defaults, and this extends to defaults defined in arguments to <code>or</code>, and to composed configurations when using parallel composition (e.g. <code>parMapN</code>).</p>
<p>The <code>ConfigError</code> and <code>ConfigErrors</code> concepts in v0.x have also been combined into a single <code>ConfigError</code> concept, with support for both horizontal composition (through <code>or</code>) and vertical composition (parallelly, through <code>and</code>). Errors are mostly handled internally, and as users we most often only use <code>ConfigValue</code>.</p>
<h2><a class="anchor" aria-hidden="true" id="decoders-are-only-for-conversions"></a><a href="#decoders-are-only-for-conversions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Decoders are only for conversions</h2>
<p>In Ciris v0.x, we used to say <code>env[Option[Int]](&quot;MAX_RETRIES&quot;)</code> for optional values and <code>Secret[Int]</code> for secret values. This worked because <code>ConfigDecoder</code>s could inspect errors of the value they were decoding, and create a new value based on that information.</p>
<p>In Ciris v1.0.0, <code>ConfigDecoder</code>s can only access the value (and a description of the key, if available). So while it's possible to describe <code>Option</code> or <code>Secret</code> decoders, they won't get the right semantics — i.e. <code>None</code> as default value for <code>Option</code>, and sensitive details redacted from error messages for <code>Secret</code>.</p>
<p>Instead, we use functions like <code>option</code> and <code>secret</code> on <code>ConfigValue</code>s to achieve the same result.</p>
<pre><code class="hljs css language-scala">env(<span class="hljs-string">"MAX_RETRIES"</span>).as[<span class="hljs-type">Int</span>].option

env(<span class="hljs-string">"API_KEY"</span>).or(prop(<span class="hljs-string">"api.key"</span>)).secret
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="configuration-sources-as-functions"></a><a href="#configuration-sources-as-functions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configuration sources as functions</h2>
<p>Ciris 0.x had the <code>ConfigSource</code> concept for describing how to load <code>ConfigValue</code>s. In v1.0.0, this concept has been removed, and we can now <a href="https://cir.is/docs/configurations#sources">create <code>ConfigValue</code>s</a>. Functions <code>ConfigValue.loaded</code>, <code>ConfigValue.missing</code>, <code>ConfigValue.suspend</code>, and similar functions enable us to describe configuration loading without ever talking about specific effect types.</p>
<p>Following is the definition of <code>file</code>, showing how to load file contents.</p>
<pre><code class="hljs css language-scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">file</span></span>(path: <span class="hljs-type">Path</span>, blocker: <span class="hljs-type">Blocker</span>, charset: <span class="hljs-type">Charset</span>): <span class="hljs-type">ConfigValue</span>[<span class="hljs-type">String</span>] =
  <span class="hljs-type">ConfigValue</span>.blockOn(blocker) {
    <span class="hljs-type">ConfigValue</span>.suspend {
      <span class="hljs-keyword">val</span> key = <span class="hljs-type">ConfigKey</span>.file(path, charset)

      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">val</span> bytes = <span class="hljs-type">Files</span>.readAllBytes(path)
        <span class="hljs-keyword">val</span> value = <span class="hljs-keyword">new</span> <span class="hljs-type">String</span>(bytes, charset)
        <span class="hljs-type">ConfigValue</span>.loaded(key, value)
      } <span class="hljs-keyword">catch</span> {
        <span class="hljs-keyword">case</span> _: <span class="hljs-type">NoSuchFileException</span> =&gt;
          <span class="hljs-type">ConfigValue</span>.missing(key)
      }
    }
  }
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="keys-are-actually-descriptions"></a><a href="#keys-are-actually-descriptions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Keys are actually descriptions</h2>
<p>In Ciris 0.x, <code>ConfigKeyType</code> provided the name for keys, e.g. <code>environment variable</code>. Key and <code>ConfigKeyType</code> would then be passed throughout the configuration loading, in order to support sensible error messages. This has been simplified in v1.0.0 to <code>ConfigKey</code>, which fully describes the key, e.g. <code>environment variable API_KEY</code>.</p>
</span></div></div><div class="blogSocialSection"></div></div><div class="blog-recent"><a class="button" href="/blog/">Recent Posts</a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#why-cant-i-just-flatmap-parmapn-">Why can't I just <code>flatMap</code>, <code>parMapN</code>, ...?</a></li><li><a href="#why-envenvf-proppropf-">Why <code>env</code>/<code>envF</code>, <code>prop</code>/<code>propF</code>, ...?</a></li><li><a href="#unifying-and-simplifying-concepts">Unifying and simplifying concepts</a></li><li><a href="#decoders-are-only-for-conversions">Decoders are only for conversions</a></li><li><a href="#configuration-sources-as-functions">Configuration sources as functions</a></li><li><a href="#keys-are-actually-descriptions">Keys are actually descriptions</a></li></ul></nav></div><footer class="nav-footer" id="footer"><hr class="separator"/><section class="copyright">Copyright © 2017-2022 Viktor Lövgren.<br/>Icon designed by <a href="https://www.flaticon.com/authors/freepik" rel="noopener">Freepik</a> from Flaticon.</section></footer></div></body></html>